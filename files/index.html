<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spiral Stock Chart - vectorbt Backend</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0e27;
            color: #fff;
            overflow-x: hidden;
        }
        
        #canvas-container {
            width: 100%;
            height: 100vh;
            position: relative;
        }
        
        #info-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 320px;
            z-index: 10;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 20px;
        }
        
        .control-group {
            margin-bottom: 16px;
        }
        
        label {
            display: block;
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        input[type="text"], input[type="range"], button {
            width: 100%;
            padding: 8px 12px;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
        }
        
        input[type="text"] {
            text-transform: uppercase;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-weight: 600;
            transition: opacity 0.2s;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        input[type="range"] {
            padding: 0;
            height: 40px;
        }
        
        .range-labels {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
        }
        
        .time-display {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            text-align: center;
            margin-bottom: 12px;
        }
        
        .hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 13px;
            color: #94a3b8;
        }
        
        .legend {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 10px;
        }

        .backend-status {
            font-size: 11px;
            color: #10b981;
            margin-bottom: 12px;
            padding: 8px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 6px;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .backend-status.error {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.2);
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    
    <div id="info-panel">
        <h1>Spiral Stock Chart</h1>
        <p class="subtitle">3D spiral visualization with vectorbt backend</p>
        
        <div id="backendStatus" class="backend-status">
            Connecting to backend...
        </div>
        
        <div class="control-group">
            <label>Stock 1</label>
            <input type="text" id="stock1Input" placeholder="e.g. AAPL" value="AAPL">
        </div>
        
        <div class="control-group">
            <label>Stock 2</label>
            <input type="text" id="stock2Input" placeholder="e.g. GOOG" value="GOOG">
        </div>
        
        <div class="control-group">
            <label>Stock 3</label>
            <input type="text" id="stock3Input" placeholder="e.g. MSFT" value="MSFT">
        </div>
        
        <div class="control-group">
            <button id="loadButton">Load Stock Data</button>
        </div>
        
        <div class="control-group">
            <label>Time Period</label>
            <div class="time-display" id="timeDisplay">1 Year</div>
            <input type="range" id="timeRange" min="1" max="6" value="4" step="1">
            <div class="range-labels">
                <span>1 Week</span>
                <span>5 Years</span>
            </div>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #667eea;"></div>
                <span id="stock1Name">Stock 1</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #10b981;"></div>
                <span id="stock2Name">Stock 2</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f59e0b;"></div>
                <span id="stock3Name">Stock 3</span>
            </div>
        </div>
    </div>
    
    <div class="hint">Drag to rotate the 3D plot</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Backend configuration
        var BACKEND_URL = 'http://localhost:5000';
        var backendAvailable = false;

        // Time period configurations
        var timePeriods = {
            1: { label: '1 Week', days: 5 },
            2: { label: '1 Month', days: 21 },
            3: { label: '3 Months', days: 63 },
            4: { label: '1 Year', days: 252 },
            5: { label: '3 Years', days: 756 },
            6: { label: '5 Years', days: 1260 }
        };

        // Current state
        var currentPeriod = 4;
        var currentStocks = ['AAPL', 'GOOG', 'MSFT'];
        var stockColors = [0x667eea, 0x10b981, 0xf59e0b];

        // Check backend health
        function checkBackend() {
            fetch(BACKEND_URL + '/api/health')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'healthy') {
                        backendAvailable = true;
                        updateBackendStatus('Backend connected âœ“', false);
                    }
                })
                .catch(error => {
                    backendAvailable = false;
                    updateBackendStatus('Backend offline - using simulated data', true);
                    console.log('Backend not available, will use simulated data');
                });
        }

        function updateBackendStatus(message, isError) {
            var statusEl = document.getElementById('backendStatus');
            statusEl.textContent = message;
            if (isError) {
                statusEl.classList.add('error');
            } else {
                statusEl.classList.remove('error');
            }
        }

        // Three.js setup
        var scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0e27);

        var camera = new THREE.PerspectiveCamera(
            45,
            window.innerWidth / window.innerHeight,
            0.1,
            1000
        );

        var renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // Lighting
        var ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        var directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(10, 20, 10);
        scene.add(directionalLight);

        var spiralGroups = [];

        // Fetch data from backend
        function fetchStockData(symbol, days, callback) {
            if (!backendAvailable) {
                callback(new Error('Backend not available'), null);
                return;
            }

            fetch(BACKEND_URL + '/api/stock/' + symbol + '?days=' + days)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        var stockData = result.data;
                        var formattedData = {
                            name: stockData.symbol,
                            symbol: stockData.symbol,
                            dates: stockData.data.map(d => d.date),
                            prices: stockData.data.map(d => d.close),
                            stats: stockData.stats
                        };
                        callback(null, formattedData);
                    } else {
                        callback(new Error(result.error), null);
                    }
                })
                .catch(error => {
                    callback(error, null);
                });
        }

        // Generate simulated data as fallback
        function getSimulatedStockData(symbol, days, index) {
            var seed = symbol.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            var rng = (function(s) {
                return function() {
                    s = Math.sin(s) * 10000;
                    return s - Math.floor(s);
                };
            })(seed);

            var basePrice = 100 + rng() * 200;
            var volatility = 0.02;
            var prices = [];
            var dates = [];
            var currentPrice = basePrice;
            var endDate = new Date();
            var currentDate = new Date(endDate.getTime() - days * 24 * 60 * 60 * 1000);

            for (var i = 0; i < days; i++) {
                var change = (rng() - 0.5) * volatility;
                currentPrice *= (1 + change);
                prices.push(currentPrice);
                
                var dateStr = currentDate.toISOString().split('T')[0];
                dates.push(dateStr);
                currentDate.setDate(currentDate.getDate() + 1);
            }

            return {
                name: symbol,
                symbol: symbol,
                dates: dates,
                prices: prices
            };
        }

        // Create text sprite for labels
        function createTextSprite(text, size, color) {
            var canvas = document.createElement('canvas');
            var context = canvas.getContext('2d');
            canvas.width = 512;
            canvas.height = 256;
            
            context.fillStyle = color;
            context.font = 'Bold ' + size + 'px Arial';
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            context.fillText(text, 256, 128);
            
            var texture = new THREE.Texture(canvas);
            texture.needsUpdate = true;
            
            var spriteMaterial = new THREE.SpriteMaterial({ 
                map: texture,
                transparent: true
            });
            var sprite = new THREE.Sprite(spriteMaterial);
            
            return sprite;
        }

        // Create price ruler
        function createPriceRuler(minPrice, maxPrice) {
            var group = new THREE.Group();
            var steps = 5;
            var priceStep = (maxPrice - minPrice) / (steps - 1);
            
            for (var i = 0; i < steps; i++) {
                var price = minPrice + (priceStep * i);
                var y = (price - minPrice) / (maxPrice - minPrice) * 30;
                
                var lineGeometry = new THREE.BufferGeometry();
                var lineVertices = new Float32Array([
                    -2, y, 0,
                    2, y, 0
                ]);
                lineGeometry.setAttribute('position', new THREE.BufferAttribute(lineVertices, 3));
                var lineMaterial = new THREE.LineBasicMaterial({ 
                    color: 0x444444,
                    transparent: true,
                    opacity: 0.3
                });
                var line = new THREE.Line(lineGeometry, lineMaterial);
                group.add(line);
                
                var label = createTextSprite('$' + price.toFixed(0), 48, '#888888');
                label.position.set(-4, y, 0);
                label.scale.set(2, 1, 1);
                group.add(label);
            }
            
            return group;
        }

        // Create spiral chart for a stock
        function createSpiralChart(stockData, totalDays, stockIndex, globalMin, globalMax) {
            var group = new THREE.Group();
            var prices = stockData.prices;
            var dates = stockData.dates;
            var color = stockColors[stockIndex];
            
            var points = [];
            var colors = [];
            var radius = 10 + stockIndex * 3;
            
            for (var i = 0; i < prices.length; i++) {
                var angle = (i / prices.length) * Math.PI * 6;
                var price = prices[i];
                var normalizedPrice = (price - globalMin) / (globalMax - globalMin);
                var y = normalizedPrice * 30;
                
                var x = Math.cos(angle) * radius;
                var z = Math.sin(angle) * radius;
                
                points.push(new THREE.Vector3(x, y, z));
                
                var r = ((color >> 16) & 255) / 255;
                var g = ((color >> 8) & 255) / 255;
                var b = (color & 255) / 255;
                colors.push(r, g, b);
            }
            
            var geometry = new THREE.BufferGeometry().setFromPoints(points);
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            
            var material = new THREE.LineBasicMaterial({ 
                vertexColors: true,
                linewidth: 2
            });
            var line = new THREE.Line(geometry, material);
            group.add(line);
            
            var pointsGeometry = new THREE.BufferGeometry().setFromPoints(points);
            pointsGeometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            var pointsMaterial = new THREE.PointsMaterial({ 
                size: 0.3,
                vertexColors: true
            });
            var pointsObj = new THREE.Points(pointsGeometry, pointsMaterial);
            group.add(pointsObj);
            
            // Add labels
            var labelsToShow = 4;
            var step = Math.floor(prices.length / labelsToShow);
            
            for (var i = 0; i < prices.length; i += step) {
                if (i > 0 && i < prices.length - 1) {
                    var date = new Date(dates[i]);
                    var dateStr = date.toLocaleString('default', { month: 'short', year: 'numeric' });
                    var colorHex = '#' + color.toString(16).padStart(6, '0');
                    var label = createTextSprite(dateStr, 60, colorHex);
                    label.position.copy(points[i]);
                    label.position.y += 1;
                    label.scale.set(2.5, 1.25, 1);
                    group.add(label);
                }
            }
            
            // End date label
            if (dates.length > 0) {
                var endDate = new Date(dates[dates.length - 1]);
                var endDateStr = endDate.toLocaleString('default', { month: 'short', year: 'numeric' });
                var colorHex = '#' + color.toString(16).padStart(6, '0');
                var endLabel = createTextSprite(endDateStr, 70, colorHex);
                endLabel.position.copy(points[points.length - 1]);
                endLabel.position.x += 2;
                endLabel.position.y += 2;
                endLabel.scale.set(3, 1.5, 1);
                group.add(endLabel);
            }
            
            return group;
        }

        // Clear and update visualization
        function updateVisualization() {
            for (var i = 0; i < spiralGroups.length; i++) {
                scene.remove(spiralGroups[i]);
            }
            spiralGroups = [];
            
            var days = timePeriods[currentPeriod].days;
            loadStockData(days);
        }

        // Load stock data (from backend or simulated)
        function loadStockData(days) {
            var completed = 0;
            var stockDataArray = [];
            var errors = [];
            
            document.getElementById('loadButton').disabled = true;
            document.getElementById('loadButton').textContent = 'Loading...';
            
            for (var i = 0; i < currentStocks.length; i++) {
                if (currentStocks[i]) {
                    (function(index, symbol) {
                        fetchStockData(symbol, days, function(error, data) {
                            if (error || !backendAvailable) {
                                var fallbackData = getSimulatedStockData(symbol, days, index);
                                fallbackData.color = stockColors[index];
                                stockDataArray[index] = fallbackData;
                                document.getElementById('stock' + (index + 1) + 'Name').textContent = 
                                    symbol + ' (Simulated)';
                            } else {
                                data.color = stockColors[index];
                                stockDataArray[index] = data;
                                document.getElementById('stock' + (index + 1) + 'Name').textContent = 
                                    data.name + ' (vectorbt)';
                            }
                            
                            completed++;
                            if (completed === currentStocks.filter(function(s) { return s; }).length) {
                                renderStocks(stockDataArray, days);
                                document.getElementById('loadButton').disabled = false;
                                document.getElementById('loadButton').textContent = 'Load Stock Data';
                            }
                        });
                    })(i, currentStocks[i]);
                }
            }
        }

        // Render stocks on the chart
        function renderStocks(stockDataArray, days) {
            var globalMin = Infinity;
            var globalMax = -Infinity;
            
            for (var i = 0; i < stockDataArray.length; i++) {
                if (stockDataArray[i]) {
                    var prices = stockDataArray[i].prices;
                    for (var j = 0; j < prices.length; j++) {
                        if (prices[j] < globalMin) globalMin = prices[j];
                        if (prices[j] > globalMax) globalMax = prices[j];
                    }
                }
            }
            
            for (var i = 0; i < stockDataArray.length; i++) {
                if (stockDataArray[i]) {
                    var group = createSpiralChart(stockDataArray[i], days, i, globalMin, globalMax);
                    scene.add(group);
                    spiralGroups.push(group);
                }
            }
            
            var ruler = createPriceRuler(globalMin, globalMax);
            scene.add(ruler);
            spiralGroups.push(ruler);
        }

        // Event listeners
        document.getElementById('loadButton').addEventListener('click', function() {
            var stock1 = document.getElementById('stock1Input').value.trim().toUpperCase();
            var stock2 = document.getElementById('stock2Input').value.trim().toUpperCase();
            var stock3 = document.getElementById('stock3Input').value.trim().toUpperCase();
            
            currentStocks = [];
            if (stock1) currentStocks.push(stock1);
            if (stock2) currentStocks.push(stock2);
            if (stock3) currentStocks.push(stock3);
            
            updateVisualization();
        });

        document.getElementById('timeRange').addEventListener('input', function(e) {
            currentPeriod = parseInt(e.target.value);
            document.getElementById('timeDisplay').textContent = timePeriods[currentPeriod].label;
            updateVisualization();
        });

        // Mouse interaction
        var isDragging = false;
        var previousMousePosition = { x: 0, y: 0 };
        var rotation = { x: -0.5, y: 0 };
        var targetRotation = { x: -0.5, y: 0 };

        renderer.domElement.addEventListener('mousedown', function(e) {
            isDragging = true;
            previousMousePosition = { x: e.clientX, y: e.clientY };
        });

        renderer.domElement.addEventListener('mousemove', function(e) {
            if (isDragging) {
                var deltaX = e.clientX - previousMousePosition.x;
                var deltaY = e.clientY - previousMousePosition.y;
                
                targetRotation.y += deltaX * 0.005;
                targetRotation.x += deltaY * 0.005;
                targetRotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, targetRotation.x));
                
                previousMousePosition = { x: e.clientX, y: e.clientY };
            }
        });

        renderer.domElement.addEventListener('mouseup', function() {
            isDragging = false;
        });

        renderer.domElement.addEventListener('mouseleave', function() {
            isDragging = false;
        });

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            
            rotation.x += (targetRotation.x - rotation.x) * 0.1;
            rotation.y += (targetRotation.y - rotation.y) * 0.1;
            
            var distance = 60;
            camera.position.x = distance * Math.sin(rotation.y) * Math.cos(rotation.x);
            camera.position.y = distance * Math.sin(rotation.x) + 20;
            camera.position.z = distance * Math.cos(rotation.y) * Math.cos(rotation.x);
            camera.lookAt(0, 15, 0);
            
            renderer.render(scene, camera);
        }
        animate();

        // Window resize
        window.addEventListener('resize', function() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Initialize
        checkBackend();
        updateVisualization();
    </script>
</body>
</html>
